<html>
    <head>
        <link rel="stylesheet" href="controller/controller.css">
        <link rel="stylesheet" href="toolbar/toolbar.css">
        <link rel="stylesheet" href="sequencer/sequencer.css">
        <style>
            html {
                overflow-y: scroll;
                height: 100vh;
                scroll-snap-type: y mandatory;
            }

            #monitors {
                position: fixed;
                right:16px;
                bottom: 16px;
                display: flex;
                gap:16px;
                flex-direction:column;
                max-height: calc(100vh - 32px);
            }
            
            .monitor {
                width: 640px;
                height: 480px;
                resize:both;
                border: 1px solid #444;
                z-index: 100; 
            }

            #sequencer {
                width: 100%;
                scroll-snap-align: end;
                scroll-snap-stop: always;
                overflow: hidden;
                max-height: 500px;
            }

            #controller {
                scroll-snap-align: start;
                scroll-snap-stop: always;
                min-height: 100vh;
            }
        </style>
        </link>
        <title>Controller - Hyperion</title>
        <script type="module">
            import { ControllerApp } from "./controller/controller.js"
            import { SequencerApp } from "./sequencer/sequencer.js"
            import { Toolbar } from "./toolbar/toolbar.js"
            import { html, render } from './common/preact-standalone.js'

            render(html`<${ControllerApp}/>`, document.getElementById('controller'));
            render(html`<${SequencerApp}/>`, document.getElementById('sequencer'));
            render(html`<${Toolbar}/>`, document.getElementById('toolbar'));
                
            const onBuildIdChange = () =>
            {
                window.location.reload();
            }
            window.onBuildIdChange=onBuildIdChange

            const createIframe = (url, scene) => {
                const iframe = document.createElement("iframe");
                iframe.src = url
                iframe.className = "monitor"
                document.getElementById('monitors').appendChild(iframe)
                iframe.contentWindow.scene = scene
                iframe.contentWindow.onBuildIdChange = onBuildIdChange
            }

            const addMonitors = () => {
                fetch("./monitor2d/mapping.json").then(i=>i.json()).then(scene2d => {if (scene2d.length) createIframe("./monitor2d/", scene2d); });
                fetch("./monitor/mapping.json"  ).then(i=>i.json()).then(scene3d => {if (scene3d.length) createIframe("./monitor/", scene3d); });
            }
            addMonitors();

            window.addEventListener("message", (event) => {
                if (event.data.type !== "toggleMonitor") return;

                if (event.data.state) {
                    addMonitors();
                } else {
                    const monitors = document.getElementById('monitors');
                    while (monitors.firstChild) {
                        monitors.removeChild(monitors.firstChild);
                    }
                }
            });

        </script>
    </head>
    <body>        
        <div id="sequencer"></div>
        <div id="controller"></div>
        <div id="monitors"></div>
        <div id="toolbar"></div>
    </body>
</html>