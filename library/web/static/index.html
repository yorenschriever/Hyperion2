<html>
    <head>
        <!-- <meta name="viewport" content="width=device-width, initial-scale=0.5"> -->
        <link rel="stylesheet" href="controller/controller.css">
        <link rel="stylesheet" href="toolbar/toolbar.css">
        <link rel="stylesheet" href="sequencer/sequencer.css">
        <style>
            #monitors {
                display: flex;
                grid-area: monitors;
            }
            
            .monitor {
                border: 1px solid #444;
                flex-grow: 1;
            }

            #sequencer {
                grid-area: sequencer;
            }

            #controller {
                grid-area: controller;
            }

            @media (aspect-ratio > 21/9) {
                body {
                    height: 100dvh;
                    display: grid;
                    grid-template-columns: auto 25vw;
                    grid-template-rows: min-content auto;
                    grid-template-areas: 
                        "sequencer monitors"
                        "controller monitors";
                }

                body.nomonitor {
                    grid-template-columns: auto;
                }

                #controller {
                    overflow: scroll;
                }

                #monitors {
                    flex-direction: column;
                    align-content: stretch;
                    height: 100dvh;
                }
            }

            @media (aspect-ratio < 9/16) {
                body {
                    height: 100dvh;
                    display: grid;
                    grid-template-rows: min-content auto 25vh;
                    grid-template-areas: 
                        "sequencer"
                        "controller"
                        "monitors";
                }

                body.nomonitor {
                    grid-template-rows: min-content auto;
                }

                #controller {
                    overflow: scroll;
                }

                #monitors {
                    flex-direction: row;
                    align-content: stretch;
                }
            }

            @media (9/16 <= aspect-ratio <= 21/9)  {
                #monitors {
                    position: fixed;
                    right:16px;
                    bottom: 16px;
                    gap: 16px;
                    flex-direction: column;
                }

                .monitor {
                    width: 640px;
                    height: 480px;
                }
            }
        </style>
        </link>
        <title>Controller - Hyperion</title>
        <script type="module">
            import { ControllerApp } from "./controller/controller.js"
            import { SequencerApp } from "./sequencer/sequencer.js"
            import { Toolbar } from "./toolbar/toolbar.js"
            import { html, render } from './common/preact-standalone.js'

            render(html`<${ControllerApp}/>`, document.getElementById('controller'));
            render(html`<${SequencerApp}/>`, document.getElementById('sequencer'));
            render(html`<${Toolbar}/>`, document.getElementById('toolbar'));
                
            const onBuildIdChange = () =>
            {
                window.location.reload();
            }
            window.onBuildIdChange=onBuildIdChange

            const createIframe = (url, scene) => {
                const iframe = document.createElement("iframe");
                iframe.src = url
                iframe.className = "monitor"
                document.getElementById('monitors').appendChild(iframe)
                iframe.contentWindow.scene = scene
                iframe.contentWindow.onBuildIdChange = onBuildIdChange
            }

            const addMonitors = () => {
                fetch("./monitor2d/mapping.json").then(i=>i.json()).then(scene2d => {if (scene2d.length) createIframe("./monitor2d/", scene2d); });
                fetch("./monitor/mapping.json"  ).then(i=>i.json()).then(scene3d => {if (scene3d.length) createIframe("./monitor/", scene3d); });
            }
            addMonitors();

            window.addEventListener("message", (event) => {
                if (event.data.type !== "toggleMonitor") return;

                if (event.data.state) {
                    addMonitors();
                    document.body.classList.toggle("nomonitor", false);
                } else {
                    const monitors = document.getElementById('monitors');
                    while (monitors.firstChild) {
                        monitors.removeChild(monitors.firstChild);
                    }
                    document.body.classList.toggle("nomonitor", true);
                }
            });

        </script>
    </head>
    <body>
        <div id="sequencer"></div>
        <div id="controller"></div>
        <div id="monitors"></div>
        <div id="toolbar"></div>
    </body>
</html>