(()=>{"use strict";var e={611:(e,t,i)=>{i.d(t,{G:()=>d});class o{constructor(e){this.numPixels=e,this.codeLength=void 0,this.Encode=e=>e,this.Decode=e=>{if(!(e<0||e>=this.numPixels))return e},this.GetCodeLength=()=>this.codeLength,this.GetHighestCode=()=>this.numPixels,this.codeLength=Math.ceil(Math.log(this.numPixels)/Math.log(2))}}class a{constructor(e){this.numPixels=e,this.codeLength=void 0,this.codes={},this.decodes={},this.Encode=e=>this.codes[e],this.Decode=e=>this.decodes[e],this.GetCodeLength=()=>this.codeLength,this.GetHighestCode=()=>this.codes[this.numPixels-1],this.calcCodeLength=()=>{let e=2;for(;this.nCr(e,e/2)<this.numPixels;)e+=2;return e},this.nCr=(e,t)=>e===t?1:(t=t<e-t?e-t:t,this.factorialRange(t+1,e)/this.factorialRange(1,e-t)),this.factorialRange=(e,t)=>{let i=e,o=e;for(;o++<t;)i*=o;return i},this.isBalanced=e=>this.bitCount(e)===this.codeLength/2,this.bitCount=e=>16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24,this.generateCodes=()=>{let e=0,t=0;for(;e<this.numPixels;)this.isBalanced(t)&&(this.codes[e]=t,this.decodes[t]=e,e++),t++},this.codeLength=this.calcCodeLength(),this.generateCodes()}}let n=function(e){return e.Binary="Binary",e.Balanced="Balanced",e}({});const c=e=>{if(e.type===cv.CV_32FC1){console.log("special type:",e.type(),cv.CV_32FC1);const t=new cv.Mat;e.convertTo(t,cv.CV_8U,255,0);const i=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),i}const t=new cv.Mat,i=e.type()%8,o=i<=cv.CV_8S?1:i<=cv.CV_32S?1/256:255,a=i===cv.CV_8S||i===cv.CV_16S?128:0;switch(e.convertTo(t,cv.CV_8U,o,a),t.type()){case cv.CV_8UC1:cv.cvtColor(t,t,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(t,t,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}const n=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),n},s=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),r=e=>Math.sqrt([e.x,e.y].reduce(((e,t)=>e+t*t),0)),l={thresholdStep:10,minThreshold:50,maxThreshold:220,minRepeatability:2,minDistBetweenBlobs:10,filterByColor:!0,blobColor:0,filterByArea:!0,minArea:25,maxArea:5e3,filterByCircularity:!1,minCircularity:.8,maxCircularity:1e6,filterByInertia:!0,minInertiaRatio:.1,maxInertiaRatio:1e6,filterByConvexity:!0,minConvexity:.95,maxConvexity:1e6,faster:!1};function h(e,t,i){const o=new cv.MatVector,a=new cv.Mat;i.faster?cv.findContours(t,o,a,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE):cv.findContours(t,o,a,cv.RETR_LIST,cv.CHAIN_APPROX_NONE),a.delete();const n=[],c=[];for(let l=0;l<o.size();l++){const e=o.get(l);c.push(e);const a=cv.contourArea(e);if(0===a)continue;let h,d;if(i.faster){const{x:t,y:i,width:o,height:a}=cv.boundingRect(e);h={confidence:1,location:{x:t+o/2,y:i+a/2},radius:(o+a)/4}}else d=cv.moments(e),h={confidence:1,location:{x:d.m10/d.m00,y:d.m01/d.m00}};if(!i.filterByArea||!(a<i.minArea||a>=i.maxArea)){if(i.filterByCircularity){const t=cv.arcLength(e,!0),o=4*cv.CV_PI*a/(t*t);if(o<i.minCircularity||o>=i.maxCircularity)continue}if(i.filterByInertia){if(i.faster)throw new Error("Cannot both set params.faster and params.filterByInertia");const e=Math.sqrt(Math.pow(2*d.mu11,2)+Math.pow(d.mu20-d.mu02,2));let t;if(e>.01){const i=(d.mu20-d.mu02)/e,o=2*d.mu11/e,a=-i,n=-o;t=(.5*(d.mu20+d.mu02)-.5*(d.mu20-d.mu02)*i-d.mu11*o)/(.5*(d.mu20+d.mu02)-.5*(d.mu20-d.mu02)*a-d.mu11*n)}else t=1;if(t<i.minInertiaRatio||t>=i.maxInertiaRatio)continue;h.confidence=t*t}if(i.filterByConvexity){const t=new cv.Mat;cv.convexHull(e,t);const o=a/cv.contourArea(t);if(t.delete(),o<i.minConvexity||o>=i.maxConvexity)continue}if(!i.filterByColor||t.ucharAt(Math.round(h.location.y),Math.round(h.location.x))===i.blobColor){if(!i.faster){const t=[];for(let i=0;i<e.size().height;i++){const o=e.intPtr(i);t.push(r(s(h.location,{x:o[0],y:o[1]})))}t.sort(),h.radius=(t[Math.floor((t.length-1)/2)]+t[Math.floor(t.length/2)])/2}n.push(h)}}}return c.forEach((e=>e.delete())),o.delete(),n}class d{constructor(e){var t=this;this.callback=e,this.codedImage=[],this.codedImageNegative=[],this.startImage=void 0,this.encoder=void 0,this.initialized=!1,this.numSlices=0,this.numPixels=0,this.config={blur:11,align:!0,imgWidth:1280,livePreview:!0,connectPoints:!0,labelPoints:!0},this.init=(e,t,i,c,s)=>{var r;if(this.initialized=!0,console.log("initializing mapper",{numPixels:c,encoderType:s}),this.sendStatus("Initializing"),this.encoder=((e,t)=>{switch(e){case n.Balanced:return new a(t);case n.Binary:default:return new o(t)}})(s,c),this.numPixels=c,this.numSlices=i.length,this.numSlices!==this.encoder.GetCodeLength())throw Error("number of images does not match encoder code length");let l;t&&(this.sendStatus("Preparing black image"),l=this.prepareImage(t,void 0,void 0,!1)),this.sendStatus("Preparing start image"),this.startImage=this.prepareImage(e,l,void 0,!0),this.sendStatus("Processing slice images"),this.codedImage=[],this.codedImageNegative=[],i.forEach((e=>{const t=this.prepareImage(e,l,this.startImage,!0);this.codedImage.push(t),this.codedImageNegative.push(this.invertColors(t))})),t.delete(),e.delete(),i.forEach((e=>e.delete())),null===(r=l)||void 0===r||r.delete()},this.run=()=>{if(!this.initialized||!this.startImage)throw Error("Must initialize before decoding");this.sendStatus("Decoding positions"),this.decodeRecursive(this.startImage,0,this.numSlices),this.callback({type:"DONE"})},this.clean=()=>{var e;null===(e=this.startImage)||void 0===e||e.delete(),this.codedImage.forEach((e=>e.delete())),this.codedImageNegative.forEach((e=>e.delete())),this.initialized=!1},this.sendStatus=e=>{console.log(e),this.callback({type:"STATUS",msg:e})},this.decodeRecursive=(e,t,i)=>{if(0===i){const i=this.encoder.Decode(t);void 0!==i&&i>=0&&i<this.numPixels&&this.detectSinglePixel(e,i,t)}else{const o=new cv.Mat(e.size(),cv.CV_32F),a=new cv.Mat(e.size(),cv.CV_32F);cv.multiply(e,this.codedImage[i-1],o),cv.multiply(e,this.codedImageNegative[i-1],a),t<<1<=this.encoder.GetHighestCode()&&(this.decodeRecursive(a,t<<1,i-1),this.decodeRecursive(o,t<<1|1,i-1)),o.delete(),a.delete()}},this.detectParams={thresholdStep:64,minThreshold:64,maxThreshold:255,minDistBetweenBlobs:10,filterByColor:!1,filterByArea:!1,filterByInertia:!1,filterByConvexity:!1,minRepeatability:1,minArea:2,maxArea:500,faster:!0},this.detectSinglePixel=(e,t,i)=>{const o=cv.minMaxLoc(e).maxVal;e.convertTo(e,cv.CV_32FC1,1/o);const a=function(e,t){t={...l,...t};const i=new cv.Mat(e.rows,e.cols,cv.CV_8UC1);e.type()===cv.CV_32FC1?e.convertTo(i,cv.CV_8UC1,255):cv.cvtColor(e,i,cv.COLOR_RGB2GRAY);let o=[];for(let l=t.minThreshold;l<t.maxThreshold;l+=t.thresholdStep){const m=new cv.Mat(e.rows,e.cols,cv.CV_8UC1);cv.threshold(i,m,l,255,cv.THRESH_BINARY);let v=h(0,m,t);m.delete();let u=[];for(let e=0;e<v.length;e++){let i=!0;for(let l=0;l<o.length;l++){var a,n;const h=r(s(o[l][Math.floor(o[l].length/2)].location,v[e].location));if(i=h>=t.minDistBetweenBlobs&&h>=(null!==(a=o[l][Math.floor(o[l].length/2)].radius)&&void 0!==a?a:0)&&h>=(null!==(n=v[e].radius)&&void 0!==n?n:0),!i){o[l].push(v[e]);let t=o[l].length-1;for(;t>0&&(null!==(c=o[l][t].radius)&&void 0!==c?c:0)<(null!==(d=o[l][t-1].radius)&&void 0!==d?d:0);){var c,d;o[l][t]=o[l][t-1],t--}o[l][t]=v[e];break}}i&&u.push([v[e]])}o=o.concat(u)}i.delete();const m=[];for(let s=0;s<o.length;s++){var v;if(o[s].length<t.minRepeatability)continue;const i={x:0,y:0};let a=0;for(let e=0;e<o[s].length;e++)i.x+=o[s][e].confidence*o[s][e].location.x,i.y+=o[s][e].confidence*o[s][e].location.y,a+=o[s][e].confidence;i.x*=1/a,i.y*=1/a;let n=Math.round(2*(null!==(v=o[s][Math.floor(o[s].length/2)].radius)&&void 0!==v?v:0));n=Math.min(n,2*i.x,2*i.y,2*(e.cols-i.x),2*(e.rows-i.y)),m.push({pt:i,size:n})}return m}(e,this.detectParams).map((t=>({x:t.pt.x,y:t.pt.y,size:t.size,confidence:e.floatAt(Math.round(t.pt.y),Math.round(t.pt.x))*o})));a.sort(((e,t)=>t.confidence-e.confidence)),a.length<=3&&a.forEach((e=>e.confidence=Math.min(1,2*e.confidence))),1===a.length&&a.forEach((e=>e.confidence=Math.min(1,2*e.confidence)));const n=a&&a[0]&&a[0].confidence>=.01?a[0]:void 0;this.callback({type:"PIXELRESULT",index:t,code:i,position:n,alternativePositions:a})},this.recalculate=(e,t)=>{if(!this.initialized||!this.startImage)return;const i=this.startImage.clone();for(let a=0;a<this.numSlices;a++){e>>a&1?cv.multiply(i,this.codedImage[a],i):cv.multiply(i,this.codedImageNegative[a],i)}const o=cv.minMaxLoc(i).maxVal;i.convertTo(i,cv.CV_32FC1,1/o),this.callback({type:"RECALCULATEIMG",img:c(i),code:e,index:t}),i.delete()},this.debug=(e,t)=>{this.callback({type:"DEBUGIMG",img:c(e),msg:t})},this.invertColors=e=>{let t=cv.Mat.ones(e.size(),cv.CV_32F);return cv.subtract(t,e,t),t},this.prepareImage=function(e,i,o){let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=new cv.Mat(e.size(),cv.CV_32F);return e.convertTo(n,cv.CV_32F),cv.cvtColor(n,n,cv.COLOR_RGB2GRAY),n=t.rescaleSize(n),t.config.blur>0&&cv.GaussianBlur(n,n,new cv.Size(t.config.blur,t.config.blur),0,0),i&&cv.subtract(n,i,n),a&&cv.divide(n,cv.Mat.ones(n.size(),cv.CV_32F),n,1/256),i&&(n.convertTo(n,-1,2.2,-.25),cv.max(n,cv.Mat.zeros(n.size(),cv.CV_32F),n),cv.min(n,cv.Mat.ones(n.size(),cv.CV_32F),n)),n},this.rescaleSize=e=>{const t=e.size();if(t.width<=this.config.imgWidth)return e;const i=this.config.imgWidth,o=Math.round(t.height*(this.config.imgWidth/t.width));let a=new cv.Mat(o,i,cv.CV_32F);return cv.resize(e,a,a.size()),e.delete(),a},console.log("Pixelmapper constructor")}}},323:(e,t,i)=>{i.a(e,(async(e,t)=>{try{var o=i(611);const e=self;e.importScripts("opencv_js.js"),cv=await cv();const a=t=>e.postMessage(t),n=new o.G(a);e.addEventListener("message",(e=>{const t=e.data;switch(t.type){case"RUN":n.init(cv.matFromImageData(t.whiteImage),cv.matFromImageData(t.blackImage),t.sliceImages.map((e=>cv.matFromImageData(e))),t.numPixels,t.encoderType),n.run();break;case"RECALCULATE":n.recalculate(t.code,t.index);break;case"CLEAN":n.clean();break;case"ISINITIALIZEDREQUEST":a({type:"ISINITIALIZEDRESPONSE",initialized:n.initialized});break;case"INITONLY":n.init(cv.matFromImageData(t.whiteImage),cv.matFromImageData(t.blackImage),t.sliceImages.map((e=>cv.matFromImageData(e))),t.numPixels,t.encoderType)}})),t()}catch(a){t(a)}}),1)}},t={};function i(o){var a=t[o];if(void 0!==a)return a.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,i),n.exports}(()=>{var e="function"===typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"===typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",o="function"===typeof Symbol?Symbol("webpack error"):"__webpack_error__",a=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))};i.a=(i,n,c)=>{var s;c&&((s=[]).d=-1);var r,l,h,d=new Set,m=i.exports,v=new Promise(((e,t)=>{h=t,l=e}));v[t]=m,v[e]=e=>(s&&e(s),d.forEach(e),v.catch((e=>{}))),i.exports=v,n((i=>{var n;r=(i=>i.map((i=>{if(null!==i&&"object"===typeof i){if(i[e])return i;if(i.then){var n=[];n.d=0,i.then((e=>{c[t]=e,a(n)}),(e=>{c[o]=e,a(n)}));var c={};return c[e]=e=>e(n),c}}var s={};return s[e]=e=>{},s[t]=i,s})))(i);var c=()=>r.map((e=>{if(e[o])throw e[o];return e[t]})),l=new Promise((t=>{(n=()=>t(c)).r=0;var i=e=>e!==s&&!d.has(e)&&(d.add(e),e&&!e.d&&(n.r++,e.push(n)));r.map((t=>t[e](i)))}));return n.r?l:c()}),(e=>(e?h(v[o]=e):l(m),a(s)))),s&&s.d<0&&(s.d=0)}})(),i.d=(e,t)=>{for(var o in t)i.o(t,o)&&!i.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);i(323)})();